---
alwaysApply: true
---
# Cursor Rules - Forestal Santa Luc√≠a SpA
## Sistema de Gesti√≥n Operativa

## üìã Contexto del Proyecto

Este es un sistema web para **Forestal Santa Luc√≠a SpA**, una empresa que opera como intermediario comercial en el negocio de compra y venta de pallets de madera.

### Modelo de Negocio
- **Cliente emite OC a FSL** ‚Üí Cliente solicita pallets mediante orden de compra
- **FSL genera OC a proveedores** ‚Üí FSL solicita pallets a proveedores mediante sus propias OC
- **Operaci√≥n Unificada** ‚Üí Una operaci√≥n de venta incluye autom√°ticamente la compra asociada al proveedor
- **Sin bodega f√≠sica** ‚Üí Los pallets viajan directamente del proveedor al cliente final
- **C√°lculo autom√°tico de m√°rgenes** ‚Üí Sistema calcula rentabilidad por operaci√≥n

### Objetivo del Sistema
Sistema de **control operativo** (no contabilidad) que:
- Centraliza todas las operaciones comerciales
- Detecta autom√°ticamente documentos faltantes
- Genera √≥rdenes de compra profesionales en PDF
- Calcula m√°rgenes autom√°ticamente
- Muestra pendientes de forma clara y accionable

---

## üõ† Stack Tecnol√≥gico

### Recomendado (Next.js Full-Stack)
- **Frontend**: Next.js 14 (App Router) + TypeScript
- **UI Components**: shadcn/ui + Tailwind CSS
- **Estado**: React Query (TanStack Query)
- **Backend**: Next.js API Routes
- **ORM**: Prisma
- **Base de Datos**: PostgreSQL
- **Autenticaci√≥n**: Auth.js (NextAuth.js v5) con Credentials Provider
- **Hash de Contrase√±as**: Node.js `crypto` con `bcrypt` (salt rounds: 10)
- **Storage**: Supabase Storage o S3
- **Hosting**: Vercel

### Alternativa (Python)
- **Backend**: FastAPI
- **Frontend**: HTMX + Jinja2
- **ORM**: SQLAlchemy + Alembic
- **UI**: Tailwind CSS + DaisyUI

---

## üìä Modelo de Datos Clave

### Entidades Principales

#### Operacion (Operaci√≥n Unificada)
- **Tipo**: COMPRA, VENTA_DIRECTA, VENTA_COMISION
- **Campos clave**:
  - `numero`: Secuencial (OP-2026-00001)
  - `cliente_id`: Obligatorio si VENTA_*
  - `proveedor_id`: Obligatorio si COMPRA o VENTA_* (operaci√≥n unificada)
  - `orden_compra_cliente`: N√∫mero de OC que el cliente emiti√≥ a FSL
  - `orden_compra_generada_id`: FK a OrdenCompra (OC generada por FSL)
  - `estado_documental`: INCOMPLETA, COMPLETA
  - `estado_financiero`: PENDIENTE, FACTURADA, PAGADA, CERRADA

#### OperacionLinea
- **Para VENTA_***:
  - `precio_venta_unitario`: Precio al cliente
  - `precio_compra_unitario`: Costo al proveedor
  - `margen_unitario`: Calculado (venta - compra)
- **Para COMPRA**:
  - `precio_unitario`: Precio de compra
- **Campos comunes**:
  - `cantidad`: Solicitada original
  - `cantidad_entregada`: Recibida conforme
  - `cantidad_danada`: Pallets da√±ados/rechazados

#### OrdenCompra
- **N√∫mero**: Secuencial (OC-2026-00001)
- **Estado**: BORRADOR, ENVIADA, RECIBIDA, CANCELADA
- **PDF**: Generado autom√°ticamente, guardado en `/uploads/ocs/`
- **Asociaci√≥n**: Puede asociarse a operaci√≥n mediante `operacion_id`

#### Documento
- **Tipos**: ORDEN_COMPRA, GUIA_DESPACHO, GUIA_RECEPCION, FACTURA, CERTIFICADO_NIMF15
- **Archivo**: PDF o imagen (JPG, PNG), m√°ximo 10 MB
- **Obligatoriedad**: Depende del tipo de operaci√≥n y productos

#### Pago
- **Tipos**: COBRO_CLIENTE, PAGO_PROVEEDOR, PAGO_FLETE
- **Asociado a**: Operacion
- **Actualiza**: Estado financiero autom√°ticamente

---

## üîë Reglas de Negocio Cr√≠ticas

### Operaciones
1. **Operaci√≥n VENTA_* requiere cliente Y proveedor** (operaci√≥n unificada)
2. **Operaci√≥n VENTA_* debe tener precios de venta Y compra** en las l√≠neas
3. **Margen no puede ser negativo**: `precio_venta_unitario >= precio_compra_unitario`
4. **N√∫mero secuencial**: OP-YYYY-NNNNN (generado autom√°ticamente)
5. **Cierre requiere observaci√≥n obligatoria**

### √ìrdenes de Compra
1. **N√∫mero secuencial**: OC-YYYY-NNNNN (generado al crear PDF)
2. **OC debe tener al menos una l√≠nea** antes de generar PDF
3. **Solo OC en BORRADOR puede editarse**
4. **PDF solo se genera una vez** por OC

### Documentos
1. **Documentos obligatorios dependen del tipo de operaci√≥n**:
   - COMPRA: OC de FSL, Gu√≠a de Recepci√≥n
   - VENTA_*: OC del Cliente, OC de FSL, Gu√≠a de Despacho, Factura
   - Si hay pallet certificado: Certificado NIMF-15 obligatorio
2. **Solo PDF, JPG, PNG** (m√°ximo 10 MB)
3. **Sistema detecta autom√°ticamente documentos faltantes**

### Pagos
1. **Para operaciones de venta**: Registrar tanto cobro a cliente como pago a proveedor
2. **Estado financiero se actualiza autom√°ticamente** seg√∫n pagos
3. **M√∫ltiples pagos permitidos** (pagos parciales)

### C√°lculos Autom√°ticos
- **Total Venta**: Œ£(cantidad √ó precio_venta_unitario)
- **Total Compra**: Œ£(cantidad √ó precio_compra_unitario)
- **Margen Bruto**: Total Venta - Total Compra
- **Margen Porcentual**: (Margen Bruto / Total Venta) √ó 100

---

## üìÅ Estructura del Proyecto

```
forestal-santa-lucia/
‚îú‚îÄ‚îÄ docs/                    # Documentaci√≥n completa
‚îÇ   ‚îú‚îÄ‚îÄ PRD.md              # Product Requirements Document
‚îÇ   ‚îú‚îÄ‚îÄ SDD-forestal-santa-lucia.md  # Spec Driven Development
‚îÇ   ‚îú‚îÄ‚îÄ UI-SPEC.md          # UI Specification
‚îÇ   ‚îú‚îÄ‚îÄ API-SPEC.md         # API Specification
‚îÇ   ‚îú‚îÄ‚îÄ DATABASE-SCHEMA.md  # Database Schema
‚îÇ   ‚îî‚îÄ‚îÄ PROPUESTA-COMERCIAL.md
‚îú‚îÄ‚îÄ .cursorrules            # Este archivo
‚îî‚îÄ‚îÄ README.md
```

---

## üíª Convenciones de C√≥digo

### TypeScript/Next.js
- **TypeScript estricto**: Habilitar todas las verificaciones
- **Naming**:
  - Componentes: PascalCase (`OperacionCard.tsx`)
  - Funciones: camelCase (`crearOperacion`)
  - Constantes: UPPER_SNAKE_CASE (`ESTADO_DOCUMENTAL`)
  - Tipos/Interfaces: PascalCase (`Operacion`, `OperacionLinea`)
- **Archivos**:
  - Componentes: `components/operaciones/OperacionCard.tsx`
  - API Routes: `app/api/operaciones/route.ts`
  - Tipos: `types/operacion.ts`
  - Utils: `lib/utils.ts`

### Base de Datos (Prisma)
- **Modelos**: PascalCase singular (`Operacion`, `OperacionLinea`)
- **Campos**: snake_case (`proveedor_id`, `estado_documental`)
- **Relaciones**: Nombres descriptivos (`operacion`, `lineas`, `documentos`)

### API
- **REST JSON**: Usar est√°ndares REST
- **Respuestas**: Siempre incluir `{ success: boolean, data: T }`
- **Errores**: C√≥digos HTTP apropiados, mensajes claros
- **Validaci√≥n**: Validar en backend, nunca confiar en frontend

### UI
- **Componentes**: Usar shadcn/ui como base
- **Estilos**: Tailwind CSS (utility-first)
- **Estado**: React Query para datos del servidor
- **Formularios**: React Hook Form + Zod para validaci√≥n

---

## üéØ Principios de Dise√±o

### Simplicidad
- **Un solo usuario** en MVP (sin roles complejos)
- **Interfaz simple**: No sobrecargar con opciones
- **Flujos claros**: Cada acci√≥n debe tener un prop√≥sito claro

### Control Operativo
- **No es contabilidad**: Enfoque en control pr√°ctico del d√≠a a d√≠a
- **Alertas proactivas**: Sistema avisa, usuario no busca
- **Trazabilidad completa**: Todo documentado y rastreable

### Operaci√≥n Unificada
- **Venta y compra juntas**: Una operaci√≥n contiene ambos lados
- **M√°rgenes autom√°ticos**: Sistema calcula rentabilidad
- **OC asociada**: OC generada vinculada a la operaci√≥n

---

## üìö Documentaci√≥n de Referencia

### Documentos Principales
1. **PRD.md**: Visi√≥n del producto, objetivos, casos de uso
2. **SDD-forestal-santa-lucia.md**: Especificaci√≥n funcional completa
3. **UI-SPEC.md**: Especificaci√≥n de interfaz de usuario
4. **API-SPEC.md**: Especificaci√≥n de endpoints REST
5. **DATABASE-SCHEMA.md**: Esquema completo de base de datos

### Versiones Actuales
- SDD: v2.5 (Operaci√≥n Unificada)
- DATABASE-SCHEMA: v1.3
- UI-SPEC: v1.4
- API-SPEC: v1.4

---

## ‚ö†Ô∏è Consideraciones Importantes

### Validaciones Cr√≠ticas
- **Siempre validar en backend** (nunca confiar solo en frontend)
- **Validar m√°rgenes no negativos** antes de guardar
- **Validar documentos obligatorios** antes de cerrar operaci√≥n
- **Validar estado de OC** antes de editar/generar PDF

### Seguridad
- **Autenticaci√≥n requerida** para todas las rutas
- **Auth.js (NextAuth.js v5)**: Usar Credentials Provider para autenticaci√≥n
- **Hash de contrase√±as**: Usar `bcrypt` con `crypto` de Node.js, salt rounds: 10
- **Validar permisos** (aunque sea un solo usuario en MVP)
- **Sanitizar inputs** antes de guardar
- **Validar tipos de archivo** en uploads
- **Nunca almacenar contrase√±as en texto plano**: Siempre usar hash con bcrypt

### Performance
- **Paginaci√≥n** en listados grandes
- **√çndices** en campos de b√∫squeda frecuente
- **Lazy loading** de im√°genes/documentos
- **Cach√©** con React Query

### UX
- **Feedback inmediato**: Loading states, mensajes claros
- **Confirmaciones**: Para acciones destructivas
- **Navegaci√≥n clara**: Breadcrumbs, links obvios
- **Responsive**: Funcional en desktop (mobile no prioritario)

---

## üöÄ Roadmap

### MVP (Semanas 1-4)
- Operaciones unificadas
- Generaci√≥n de OC en PDF
- Gesti√≥n de documentos
- Dashboard de pendientes
- M√≥dulo de pagos b√°sico

### V1.1 (Semanas 5-6)
- Factoring
- Reportes simples
- Mejoras de pagos

### V1.2 (Semanas 7-8)
- Mejoras de UX
- B√∫squedas avanzadas
- Exportaci√≥n de datos

---

## üîç Cuando Implementar

### Al crear una Operaci√≥n
1. Validar que VENTA_* tenga cliente Y proveedor
2. Validar que l√≠neas tengan ambos precios (venta y compra)
3. Calcular m√°rgenes autom√°ticamente
4. Generar n√∫mero secuencial

### Al generar OC
1. Validar que tenga al menos una l√≠nea
2. Generar n√∫mero secuencial (OC-YYYY-NNNNN)
3. Crear PDF profesional
4. Cambiar estado a ENVIADA
5. Asociar a operaci√≥n si aplica

### Al subir documento
1. Validar tipo de archivo (PDF, JPG, PNG)
2. Validar tama√±o (m√°x 10 MB)
3. Actualizar estado documental autom√°ticamente
4. Mostrar alerta si completa documentos faltantes

### Al registrar pago
1. Validar monto > 0
2. Validar fecha no futura
3. Actualizar estado financiero autom√°ticamente
4. Mostrar alerta si completa pagos pendientes

---

## üìù Notas Adicionales

- **Sistema personal**: Un solo usuario en MVP, sin roles
- **No es contabilidad**: Solo control operativo
- **Sin bodega**: FSL no tiene stock f√≠sico
- **Modelo intermediaci√≥n**: Proveedor ‚Üí Cliente directo
- **Enfoque en orden**: Sistema debe ayudar a mantener todo organizado

---

**√öltima actualizaci√≥n**: 2026-01-15  
**Versi√≥n del proyecto**: MVP (Fase 1)

